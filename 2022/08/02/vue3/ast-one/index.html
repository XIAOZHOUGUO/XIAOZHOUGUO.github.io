<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>构造AST的完整流程是怎么样的？ - 上篇 | We Are ALL Made Of Star Stuff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <meta name="description" content="start from zero">
  
  
  
    <link rel="alternate" href="/atom.xml" title="We Are ALL Made Of Star Stuff" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/localshare/css/share.css">

  
  
    
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">We Are ALL Made Of Star Stuff</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">steps-by-steps</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/."><i class="fa fa-home"></i> 首页</a>
        
          <a class="main-nav-link" href="/archives/"><i class="fa fa-archive"></i> 归档</a>
        
          <a class="main-nav-link" href="/about/"><i class="fa fa-user"></i> 关于</a>
        
          <a class="main-nav-link" href="/atom.xml"><i class="fa fa-rss"></i> 订阅</a>
        
      </nav>
    </div>
    <div id="search-form">
      <div id="result-mask" class="hide"></div>
      <label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label>
      <div id="result-wrap" class="hide">
        <div id="search-result"></div>
      </div>
      <div class="hide">
        <template id="search-tpl">
          <div class="item">
            <a href="/{path}" title="{title}">
              <div class="title">{title}</div>
              <div class="time">{date}</div>
              <div class="tags">{tags}</div>
            </a>
          </div>
        </template>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-vue3/ast-one" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      构造AST的完整流程是怎么样的？ - 上篇
    </h1>
  


      </header>
    
    <div class="article-meta">
      
      <span class="article-date">
  <i class="fa fa-date"></i>
  <time class="dt-published" datetime="2022-08-02T06:58:58.000Z" itemprop="datePublished">2022年08月02日</time>
</span>
      
  <div class="article-category">
    <i class="fa fa-classify"></i>
    <a class="article-category-link" href="/categories/Vue3/">Vue3</a>
  </div>

      
        <span class="article-views">
  <i class="fa fa-views"></i>
  <i id="busuanzi_container_page_pv">
      <i id="busuanzi_value_page_pv"></i>
  </i>
</span>

      
      
<a href="/2022/08/02/vue3/ast-one/#comments" class="article-comment-link">
  
    
    
    
    
    
  
  <i class="fa fa-commt"></i>
  留言
</a>


    </div>
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Vue.js 3.0 的编译场景分<strong>服务端 SSR 编译</strong>和 <strong>web 编译</strong>，本文我们只分析 web 的编译。</p>
<span id="more"></span>

<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们先来看 web 编译的入口 compile 函数，分析它的实现原理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compile</span>(<span class="params">template, options = &#123;&#125;</span>) &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">baseCompile</span>(template, <span class="title function_">extend</span>(&#123;&#125;, parserOptions, options, &#123; </span><br><span class="line">    <span class="attr">nodeTransforms</span>: [...<span class="title class_">DOMNodeTransforms</span>, ...(options.<span class="property">nodeTransforms</span> || [])], </span><br><span class="line">    <span class="attr">directiveTransforms</span>: <span class="title function_">extend</span>(&#123;&#125;, <span class="title class_">DOMDirectiveTransforms</span>, options.<span class="property">directiveTransforms</span> || &#123;&#125;), </span><br><span class="line">    <span class="attr">transformHoist</span>:  <span class="literal">null</span> </span><br><span class="line">  &#125;)) </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>compile 函数支持两个参数，第一个参数 template 是待编译的模板字符串，第二个参数 options 是编译的一些配置信息。</p>
<p>compile 内部通过执行 baseCompile 方法完成编译工作，可以看到 baseCompile 在参数 options 的基础上又扩展了一些配置。对于这些编译相关的配置，我们后面会在具体的场景具体分析。</p>
<p>接下来，我们来看一下 baseCompile 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">baseCompile</span>(<span class="params">template,  options = &#123;&#125;</span>) &#123; </span><br><span class="line">  <span class="keyword">const</span> prefixIdentifiers = <span class="literal">false</span> </span><br><span class="line">  <span class="comment">// 解析 template 生成 AST </span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">isString</span>(template) ? <span class="title function_">baseParse</span>(template, options) : template </span><br><span class="line">  <span class="keyword">const</span> [nodeTransforms, directiveTransforms] = <span class="title function_">getBaseTransformPreset</span>() </span><br><span class="line">  <span class="comment">// AST 转换 </span></span><br><span class="line">  <span class="title function_">transform</span>(ast, <span class="title function_">extend</span>(&#123;&#125;, options, &#123; </span><br><span class="line">    prefixIdentifiers, </span><br><span class="line">    <span class="attr">nodeTransforms</span>: [ </span><br><span class="line">      ...nodeTransforms, </span><br><span class="line">      ...(options.<span class="property">nodeTransforms</span> || []) </span><br><span class="line">    ], </span><br><span class="line">    <span class="attr">directiveTransforms</span>: </span><br><span class="line">      <span class="title function_">extend</span>(&#123;&#125;, directiveTransforms, options.<span class="property">directiveTransforms</span> || &#123;&#125;) </span><br><span class="line">    &#125;)</span><br><span class="line">  ) </span><br><span class="line">  <span class="comment">// 生成代码 </span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">generate</span>(ast, <span class="title function_">extend</span>(&#123;&#125;, options, &#123; </span><br><span class="line">    prefixIdentifiers </span><br><span class="line">  &#125;)) </span><br><span class="line">&#125;     </span><br></pre></td></tr></table></figure>

<p>可以看到，baseCompile 函数主要做三件事情：<strong>解析 template 生成 AST</strong>，<strong>AST 转换</strong>和<strong>生成代码</strong>。</p>
<p>本文的目标就是<strong>解析 template 生成 AST 背后的实现原理</strong>。</p>
<h3 id="生成-AST-抽象语法树"><a href="#生成-AST-抽象语法树" class="headerlink" title="生成 AST 抽象语法树"></a>生成 AST 抽象语法树</h3><p>你可以在百度百科中看到 <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/6129952?fr=aladdin">AST 的定义</a>，这里我就不赘述啦，对应到我们的 template，也可以用 AST 去描述它，比如我们有如下 template：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;app&quot;</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!-- 这是一段注释 --&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">hello</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; msg &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">hello</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>This is an app<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p>经过第一步解析后，生成相应的AST对象：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;ns&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;div&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;tagType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;props&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">11</span> </span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">16</span> </span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\&quot;app\&quot;&quot;</span> </span><br><span class="line">            <span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">16</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class=\&quot;app\&quot;&quot;</span> </span><br><span class="line">          <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;isSelfClosing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 这是一段注释 &quot;</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">20</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">35</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;!-- 这是一段注释 --&gt;&quot;</span> </span><br><span class="line">          <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;ns&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hello&quot;</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;tagType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;props&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;isSelfClosing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">            <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;ns&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p&quot;</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;tagType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;props&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;isSelfClosing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">                <span class="punctuation">&#123;</span> </span><br><span class="line">                  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;isStatic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;isConstant&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;msg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                      <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                        <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">56</span> </span><br><span class="line">                      <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                        <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                        <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">59</span> </span><br><span class="line">                      <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;msg&quot;</span> </span><br><span class="line">                    <span class="punctuation">&#125;</span> </span><br><span class="line">                  <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                      <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">53</span> </span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                      <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                      <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">62</span> </span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123; msg &#125;&#125;&quot;</span> </span><br><span class="line">                  <span class="punctuation">&#125;</span> </span><br><span class="line">                <span class="punctuation">&#125;</span> </span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                  <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">50</span> </span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                  <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">66</span> </span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;p&gt;&#123;&#123; msg &#125;&#125;&lt;/p&gt;&quot;</span> </span><br><span class="line">              <span class="punctuation">&#125;</span> </span><br><span class="line">            <span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">38</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">77</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;hello&gt;\n    &lt;p&gt;&#123;&#123; msg &#125;&#125;&lt;/p&gt;\n  &lt;/hello&gt;&quot;</span> </span><br><span class="line">          <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;ns&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p&quot;</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;tagType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;props&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;isSelfClosing&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;children&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">            <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is an app&quot;</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                  <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">83</span> </span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                  <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">                  <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">97</span> </span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This is an app&quot;</span> </span><br><span class="line">              <span class="punctuation">&#125;</span> </span><br><span class="line">            <span class="punctuation">&#125;</span> </span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">80</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">              <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> </span><br><span class="line">              <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">101</span> </span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;p&gt;This is an app&lt;/p&gt;&quot;</span> </span><br><span class="line">          <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">          <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> </span><br><span class="line">          <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">108</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;div class=\&quot;app\&quot;&gt;\n  &lt;!-- 这是一段注释 --&gt;\n  &lt;hello&gt;\n    &lt;p&gt;&#123;&#123; msg &#125;&#125;&lt;/p&gt;\n  &lt;/hello&gt;\n  &lt;p&gt;This is an app&lt;/p&gt;\n&lt;/div&gt;&quot;</span> </span><br><span class="line">      <span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span> </span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;helpers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;components&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;directives&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;hoists&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;imports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;cached&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;temps&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;loc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span> </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">108</span> </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;div class=\&quot;app\&quot;&gt;\n  &lt;!-- 这是一段注释 --&gt;\n  &lt;hello&gt;\n    &lt;p&gt;&#123;&#123; msg &#125;&#125;&lt;/p&gt;\n  &lt;/hello&gt;\n  &lt;p&gt;This is an app&lt;/p&gt;\n&lt;/div&gt;&quot;</span> </span><br><span class="line">  <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，AST 是树状结构，对于树中的每个节点，会有 type 字段描述节点的类型，tag 字段描述节点的标签，props 描述节点的属性，loc 描述节点对应代码相关信息，children 指向它的子节点对象数组。</p>
<p>当然 AST 中的节点还包含其他的一些属性，我在这里就不一一介绍了，你现在要理解的是 <strong>AST 中的节点是可以完整地描述它在模板中映射的节点信息</strong>。</p>
<p>注意，<strong>AST 对象根节点其实是一个虚拟节点</strong>，<strong>它并不会映射到一个具体节点</strong>，另外它还包含了其他的一些属性，这些属性在后续的 AST 转换的过程中会赋值，并在生成代码阶段用到。</p>
<p>那么，为什么要设计一个虚拟节点呢？</p>
<p>因为 Vue.js 3.0 和 Vue.js 2.x 有一个很大的不同——Vue.js 3.0 支持了<code> Fragment</code> 的语法，即组件可以有多个根节点，比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;./logo.jpg&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">hello</span> <span class="attr">:msg</span>=<span class="string">&quot;msg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">hello</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这种写法在 Vue.js 2.x 中会报错，提示模板只能有一个根节点，而 Vue.js 3.0 允许了这种写法。但是对于一棵树而言，必须有一个根节点，所以虚拟节点在这种场景下就非常有用了，它可以作为 AST 的根节点，然后其 children 包含了 img 和 hello 的节点。</p>
<p>好了，到这里你已经大致了解了 AST，那么接下来我们看一下如何根据模板字符串来构建这个 AST 对象吧。</p>
<p>先来看一下 <code>baseParse</code> 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">baseParse</span>(<span class="params">content, options = &#123;&#125;</span>) &#123; </span><br><span class="line">    <span class="comment">// 创建解析上下文 </span></span><br><span class="line">    <span class="keyword">const</span> context = <span class="title function_">createParserContext</span>(content, options) </span><br><span class="line">    <span class="keyword">const</span> start = <span class="title function_">getCursor</span>(context) </span><br><span class="line">    <span class="comment">// 解析子节点，并创建 AST  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createRoot</span>(</span><br><span class="line">        <span class="title function_">parseChildren</span>(context, <span class="number">0</span> <span class="comment">/* DATA */</span>, []), </span><br><span class="line">        <span class="title function_">getSelection</span>(context, start)</span><br><span class="line">    ) </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>baseParse 主要就做三件事情：<strong>创建解析上下文</strong>，<strong>解析子节点</strong>，<strong>创建 AST 根节点</strong>。</p>
<h4 id="创建解析上下文"><a href="#创建解析上下文" class="headerlink" title="创建解析上下文"></a>创建解析上下文</h4><p>首先，我们来分析创建解析上下文的过程，先来看 <code>createParserContext</code> 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认解析配置 </span></span><br><span class="line"><span class="keyword">const</span> defaultParserOptions = &#123; </span><br><span class="line">  <span class="attr">delimiters</span>: [<span class="string">`&#123;&#123;`</span>, <span class="string">`&#125;&#125;`</span>], </span><br><span class="line">  <span class="attr">getNamespace</span>: <span class="function">() =&gt;</span> <span class="number">0</span> <span class="comment">/* HTML */</span>, </span><br><span class="line">  <span class="attr">getTextMode</span>: <span class="function">() =&gt;</span> <span class="number">0</span> <span class="comment">/* DATA */</span>, </span><br><span class="line">  <span class="attr">isVoidTag</span>: <span class="variable constant_">NO</span>, </span><br><span class="line">  <span class="attr">isPreTag</span>: <span class="variable constant_">NO</span>, </span><br><span class="line">  <span class="attr">isCustomElement</span>: <span class="variable constant_">NO</span>, </span><br><span class="line">  <span class="attr">decodeEntities</span>: <span class="function">(<span class="params">rawText</span>) =&gt;</span> rawText.<span class="title function_">replace</span>(decodeRE, <span class="function">(<span class="params">_, p1</span>) =&gt;</span> decodeMap[p1]), </span><br><span class="line">  <span class="attr">onError</span>: defaultOnError </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createParserContext</span>(<span class="params">content, options</span>) &#123; </span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    <span class="attr">options</span>: <span class="title function_">extend</span>(&#123;&#125;, defaultParserOptions, options), </span><br><span class="line">    <span class="attr">column</span>: <span class="number">1</span>, </span><br><span class="line">    <span class="attr">line</span>: <span class="number">1</span>, </span><br><span class="line">    <span class="attr">offset</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="attr">originalSource</span>: content, </span><br><span class="line">    <span class="attr">source</span>: content, </span><br><span class="line">    <span class="attr">inPre</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="attr">inVPre</span>: <span class="literal">false</span> </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析上下文实际上就是一个 JavaScript 对象，它维护着解析过程中的上下文，其中 options 表示解析相关配置 ，column 表示当前代码的列号，line 表示当前代码的行号，originalSource 表示最初的原始代码，source 表示当前代码，offset 表示当前代码相对于原始代码的偏移量，inPre 表示当前代码是否在 pre 标签内，inVPre 表示当前代码是否在 v-pre 指令的环境下。</p>
<p>在后续解析的过程中，会始终维护和更新这个解析上下文，它能够表示当前解析的状态。</p>
<p>创建完解析上下文，接下来就开始解析子节点了。</p>
<h4 id="解析子节点"><a href="#解析子节点" class="headerlink" title="解析子节点"></a>解析子节点</h4><p>我们先来看一下 <code>parseChildren</code> 函数的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseChildren</span>(<span class="params">context, mode, ancestors</span>) &#123; </span><br><span class="line">  <span class="keyword">const</span> parent = <span class="title function_">last</span>(ancestors) </span><br><span class="line">  <span class="keyword">const</span> ns = parent ? parent.<span class="property">ns</span> : <span class="number">0</span> <span class="comment">/* HTML */</span> </span><br><span class="line">  <span class="keyword">const</span> nodes = [] </span><br><span class="line">  <span class="comment">// 自顶向下分析代码，生成 nodes </span></span><br><span class="line">  <span class="keyword">let</span> removedWhitespace = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 空白字符管理 </span></span><br><span class="line">  <span class="keyword">return</span> removedWhitespace ? nodes.<span class="title function_">filter</span>(<span class="title class_">Boolean</span>) : nodes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parseChildren 的目的就是解析并创建 AST 节点数组。它有两个主要流程，第一个是自顶向下分析代码，生成 AST 节点数组 nodes；第二个是空白字符管理，用于提高编译的效率。</p>
<p>首先，我们来看<strong>生成 AST 节点数组</strong>的流程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseChildren</span>(<span class="params">context, mode, ancestors</span>) &#123; </span><br><span class="line">  <span class="comment">// 父节点 </span></span><br><span class="line">  <span class="keyword">const</span> parent = <span class="title function_">last</span>(ancestors) </span><br><span class="line">  <span class="keyword">const</span> ns = parent ? parent.<span class="property">ns</span> : <span class="number">0</span> <span class="comment">/* HTML */</span> </span><br><span class="line">  <span class="keyword">const</span> nodes = [] </span><br><span class="line">  <span class="comment">// 判断是否遍历结束 </span></span><br><span class="line">  <span class="keyword">while</span> (!<span class="title function_">isEnd</span>(context, mode, ancestors)) &#123; </span><br><span class="line">    <span class="keyword">const</span> s = context.<span class="property">source</span> </span><br><span class="line">    <span class="keyword">let</span> node = <span class="literal">undefined</span> </span><br><span class="line">    <span class="keyword">if</span> (mode === <span class="number">0</span> <span class="comment">/* DATA */</span> || mode === <span class="number">1</span> <span class="comment">/* RCDATA */</span>) &#123; </span><br><span class="line">      <span class="keyword">if</span> (!context.<span class="property">inVPre</span> &amp;&amp; <span class="title function_">startsWith</span>(s, context.<span class="property">options</span>.<span class="property">delimiters</span>[<span class="number">0</span>])) &#123; </span><br><span class="line">        <span class="comment">// 处理 &#123;&#123; 插值代码 </span></span><br><span class="line">        node = parseInterpolation(context, mode) </span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="number">0</span> <span class="comment">/* DATA */</span> &amp;&amp; s[<span class="number">0</span>] === <span class="string">&#x27;&lt;&#x27;</span>) &#123; </span><br><span class="line">        <span class="comment">// 处理 &lt; 开头的代码 </span></span><br><span class="line">        <span class="keyword">if</span> (s.<span class="property">length</span> === <span class="number">1</span>) &#123; </span><br><span class="line">          <span class="comment">// s 长度为 1，说明代码结尾是 &lt;，报错 </span></span><br><span class="line">          <span class="title function_">emitError</span>(context, <span class="number">5</span> <span class="comment">/* EOF_BEFORE_TAG_NAME */</span>, <span class="number">1</span>) </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">1</span>] === <span class="string">&#x27;!&#x27;</span>) &#123; </span><br><span class="line">          <span class="comment">// 处理 &lt;! 开头的代码 </span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">startsWith</span>(s, <span class="string">&#x27;&lt;!--&#x27;</span>)) &#123; </span><br><span class="line">            <span class="comment">// 处理注释节点 </span></span><br><span class="line">            node = <span class="title function_">parseComment</span>(context) </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">startsWith</span>(s, <span class="string">&#x27;&lt;!DOCTYPE&#x27;</span>)) &#123; </span><br><span class="line">            <span class="comment">// 处理 &lt;!DOCTYPE 节点 </span></span><br><span class="line">            node = <span class="title function_">parseBogusComment</span>(context) </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">startsWith</span>(s, <span class="string">&#x27;&lt;![CDATA[&#x27;</span>)) &#123; </span><br><span class="line">            <span class="comment">// 处理 &lt;![CDATA[ 节点 </span></span><br><span class="line">            <span class="keyword">if</span> (ns !== <span class="number">0</span> <span class="comment">/* HTML */</span>) &#123; </span><br><span class="line">              node = <span class="title function_">parseCDATA</span>(context, ancestors) </span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123; </span><br><span class="line">              <span class="title function_">emitError</span>(context, <span class="number">1</span> <span class="comment">/* CDATA_IN_HTML_CONTENT */</span>) </span><br><span class="line">              node = <span class="title function_">parseBogusComment</span>(context) </span><br><span class="line">            &#125; </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="title function_">emitError</span>(context, <span class="number">11</span> <span class="comment">/* INCORRECTLY_OPENED_COMMENT */</span>) </span><br><span class="line">            node = <span class="title function_">parseBogusComment</span>(context) </span><br><span class="line">          &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">1</span>] === <span class="string">&#x27;/&#x27;</span>) &#123; </span><br><span class="line">          <span class="comment">// 处理 &lt;/ 结束标签 </span></span><br><span class="line">          <span class="keyword">if</span> (s.<span class="property">length</span> === <span class="number">2</span>) &#123; </span><br><span class="line">            <span class="comment">// s 长度为 2，说明代码结尾是 &lt;/，报错 </span></span><br><span class="line">            <span class="title function_">emitError</span>(context, <span class="number">5</span> <span class="comment">/* EOF_BEFORE_TAG_NAME */</span>, <span class="number">2</span>) </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">2</span>] === <span class="string">&#x27;&gt;&#x27;</span>) &#123; </span><br><span class="line">            <span class="comment">// &lt;/&gt; 缺少结束标签，报错 </span></span><br><span class="line">            <span class="title function_">emitError</span>(context, <span class="number">14</span> <span class="comment">/* MISSING_END_TAG_NAME */</span>, <span class="number">2</span>) </span><br><span class="line">            <span class="title function_">advanceBy</span>(context, <span class="number">3</span>) </span><br><span class="line">            <span class="keyword">continue</span> </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/[a-z]/i</span>.<span class="title function_">test</span>(s[<span class="number">2</span>])) &#123; </span><br><span class="line">            <span class="comment">// 多余的结束标签 </span></span><br><span class="line">            <span class="title function_">emitError</span>(context, <span class="number">23</span> <span class="comment">/* X_INVALID_END_TAG */</span>) </span><br><span class="line">            <span class="title function_">parseTag</span>(context, <span class="number">1</span> <span class="comment">/* End */</span>, parent) </span><br><span class="line">            <span class="keyword">continue</span> </span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="title function_">emitError</span>(context, <span class="number">12</span> <span class="comment">/* INVALID_FIRST_CHARACTER_OF_TAG_NAME */</span>, <span class="number">2</span>) </span><br><span class="line">            node = <span class="title function_">parseBogusComment</span>(context) </span><br><span class="line">          &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/[a-z]/i</span>.<span class="title function_">test</span>(s[<span class="number">1</span>])) &#123; </span><br><span class="line">          <span class="comment">// 解析标签元素节点 </span></span><br><span class="line">          node = <span class="title function_">parseElement</span>(context, ancestors) </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s[<span class="number">1</span>] === <span class="string">&#x27;?&#x27;</span>) &#123; </span><br><span class="line">          <span class="title function_">emitError</span>(context, <span class="number">21</span> <span class="comment">/* UNEXPECTED_QUESTION_MARK_INSTEAD_OF_TAG_NAME */</span>, <span class="number">1</span>) </span><br><span class="line">          node = <span class="title function_">parseBogusComment</span>(context) </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">          <span class="title function_">emitError</span>(context, <span class="number">12</span> <span class="comment">/* INVALID_FIRST_CHARACTER_OF_TAG_NAME */</span>, <span class="number">1</span>) </span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (!node) &#123; </span><br><span class="line">      <span class="comment">// 解析普通文本节点 </span></span><br><span class="line">      node = <span class="title function_">parseText</span>(context, mode) </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isArray</span>(node)) &#123; </span><br><span class="line">      <span class="comment">// 如果 node 是数组，则遍历添加 </span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; node.<span class="property">length</span>; i++) &#123; </span><br><span class="line">        <span class="title function_">pushNode</span>(nodes, node[i]) </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">      <span class="comment">// 添加单个 node </span></span><br><span class="line">      <span class="title function_">pushNode</span>(nodes, node) </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些代码看起来很复杂，但它的思路就是自顶向下地去遍历代码，然后根据不同的情况尝试去解析代码，然后把生成的 node 添加到 AST nodes 数组中。在解析的过程中，解析上下文 context 的状态也是在不断发生变化的，我们可以通过 context.source 拿到当前解析剩余的代码 s，然后根据 s 不同的情况走不同的分支处理逻辑。在解析的过程中，可能会遇到各种错误，都会通过 emitError 方法报错。</p>
<p>我们没有必要去了解所有代码的分支细节，只需要知道大致的解析思路即可，因此我们这里只分析四种情况：注释节点的解析、插值的解析、普通文本的解析，以及元素节点的解析。</p>
<ul>
<li>注释节点的解析</li>
</ul>
<p>首先，我们来看注释节点的解析过程，它会解析模板中的注释节点，比如 <code>&lt;!-- 这是一段注释 --&gt;，</code> 即当前代码 s 是以 <code>&lt;!--</code> 开头的字符串，则走到注释节点的解析处理逻辑。</p>
<p>我们来看 <code>parseComment</code> 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseComment</span>(<span class="params">context</span>) &#123; </span><br><span class="line">  <span class="keyword">const</span> start = <span class="title function_">getCursor</span>(context) </span><br><span class="line">  <span class="keyword">let</span> content </span><br><span class="line">  <span class="comment">// 常规注释的结束符 </span></span><br><span class="line">  <span class="keyword">const</span> match = <span class="regexp">/--(\!)?&gt;/</span>.<span class="title function_">exec</span>(context.<span class="property">source</span>) </span><br><span class="line">  <span class="keyword">if</span> (!match) &#123; </span><br><span class="line">    <span class="comment">// 没有匹配的注释结束符 </span></span><br><span class="line">    content = context.<span class="property">source</span>.<span class="title function_">slice</span>(<span class="number">4</span>) </span><br><span class="line">    <span class="title function_">advanceBy</span>(context, context.<span class="property">source</span>.<span class="property">length</span>) </span><br><span class="line">    <span class="title function_">emitError</span>(context, <span class="number">7</span> <span class="comment">/* EOF_IN_COMMENT */</span>) </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (match.<span class="property">index</span> &lt;= <span class="number">3</span>) &#123; </span><br><span class="line">      <span class="comment">// 非法的注释符号 </span></span><br><span class="line">      <span class="title function_">emitError</span>(context, <span class="number">0</span> <span class="comment">/* ABRUPT_CLOSING_OF_EMPTY_COMMENT */</span>) </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (match[<span class="number">1</span>]) &#123; </span><br><span class="line">      <span class="comment">// 注释结束符不正确 </span></span><br><span class="line">      <span class="title function_">emitError</span>(context, <span class="number">10</span> <span class="comment">/* INCORRECTLY_CLOSED_COMMENT */</span>) </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 获取注释的内容 </span></span><br><span class="line">    content = context.<span class="property">source</span>.<span class="title function_">slice</span>(<span class="number">4</span>, match.<span class="property">index</span>) </span><br><span class="line">    <span class="comment">// 截取到注释结尾之间的代码，用于后续判断嵌套注释 </span></span><br><span class="line">    <span class="keyword">const</span> s = context.<span class="property">source</span>.<span class="title function_">slice</span>(<span class="number">0</span>, match.<span class="property">index</span>) </span><br><span class="line">    <span class="keyword">let</span> prevIndex = <span class="number">1</span>, nestedIndex = <span class="number">0</span> </span><br><span class="line">    <span class="comment">// 判断嵌套注释符的情况，存在即报错 </span></span><br><span class="line">    <span class="keyword">while</span> ((nestedIndex = s.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;!--&#x27;</span>, prevIndex)) !== -<span class="number">1</span>) &#123; </span><br><span class="line">      <span class="title function_">advanceBy</span>(context, nestedIndex - prevIndex + <span class="number">1</span>) </span><br><span class="line">      <span class="keyword">if</span> (nestedIndex + <span class="number">4</span> &lt; s.<span class="property">length</span>) &#123; </span><br><span class="line">        <span class="title function_">emitError</span>(context, <span class="number">16</span> <span class="comment">/* NESTED_COMMENT */</span>) </span><br><span class="line">      &#125; </span><br><span class="line">      prevIndex = nestedIndex + <span class="number">1</span> </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 前进代码到注释结束符后 </span></span><br><span class="line">    <span class="title function_">advanceBy</span>(context, match.<span class="property">index</span> + match[<span class="number">0</span>].<span class="property">length</span> - prevIndex + <span class="number">1</span>) </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    <span class="attr">type</span>: <span class="number">3</span> <span class="comment">/* COMMENT */</span>, </span><br><span class="line">    content, </span><br><span class="line">    <span class="attr">loc</span>: <span class="title function_">getSelection</span>(context, start) </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实，parseComment 的实现很简单，首先它会利用注释结束符的正则表达式去匹配代码，找出注释结束符。如果没有匹配到或者注释结束符不合法，都会报错。<br>如果找到合法的注释结束符，则获取它中间的注释内容 content，然后截取注释开头到结尾之间的代码，并判断是否有嵌套注释，如果有嵌套注释也会报错。</p>
<p>接着就是通过调用 advanceBy 前进代码到注释结束符后，这个函数在整个模板解析过程中经常被调用，它的目的是用来前进代码，更新 context 解析上下文，我们来看一下它的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">advanceBy</span>(<span class="params">context, numberOfCharacters</span>) &#123; </span><br><span class="line">  <span class="keyword">const</span> &#123; source &#125; = context </span><br><span class="line">  <span class="comment">// 更新 context 的 offset、line、column </span></span><br><span class="line">  <span class="title function_">advancePositionWithMutation</span>(context, source, numberOfCharacters) </span><br><span class="line">  <span class="comment">// 更新 context 的 source </span></span><br><span class="line">  context.<span class="property">source</span> = source.<span class="title function_">slice</span>(numberOfCharacters) </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">advancePositionWithMutation</span>(<span class="params">pos, source, numberOfCharacters = source.length</span>) &#123; </span><br><span class="line">  <span class="keyword">let</span> linesCount = <span class="number">0</span> </span><br><span class="line">  <span class="keyword">let</span> lastNewLinePos = -<span class="number">1</span> </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numberOfCharacters; i++) &#123; </span><br><span class="line">    <span class="keyword">if</span> (source.<span class="title function_">charCodeAt</span>(i) === <span class="number">10</span> <span class="comment">/* newline char code */</span>) &#123; </span><br><span class="line">      linesCount++ </span><br><span class="line">      lastNewLinePos = i </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">  pos.<span class="property">offset</span> += numberOfCharacters </span><br><span class="line">  pos.<span class="property">line</span> += linesCount </span><br><span class="line">  pos.<span class="property">column</span> = </span><br><span class="line">    lastNewLinePos === -<span class="number">1</span> </span><br><span class="line">      ? pos.<span class="property">column</span> + numberOfCharacters </span><br><span class="line">      : numberOfCharacters - lastNewLinePos </span><br><span class="line">  <span class="keyword">return</span> pos </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>advanceBy 的实现很简单，主要就是更新解析上下文 context 中的 source 来前进代码，同时更新 offset、line、column 等和代码位置相关的属性。</p>
<p>为了更直观地说明 advanceBy 的作用，前面的示例可以通过下图表示：</p>
<img src="/2022/08/02/vue3/ast-one/Ciqc1F88z3mACHOrAAFRdAq-Jxw187.png" class="">

<p>经过 advanceBy 前进代码到注释结束符后，表示注释部分代码处理完毕，可以继续解析后续代码了。</p>
<p>parseComment 最终返回的值就是一个描述注释节点的对象，其中 type 表示它是一个注释节点，content 表示注释的内容，loc 表示注释的代码开头和结束的位置信息。</p>
<ul>
<li>插值的解析</li>
</ul>
<p>接下来，我们来看插值的解析过程，它会解析模板中的插值，比如 <code>&#123;&#123; msg &#125;&#125;</code> ，即当前代码 s 是以 { { 开头的字符串，且不在 v-pre 指令的环境下（v-pre 会跳过插值的解析），则会走到插值的解析处理逻辑 <code>parseInterpolation</code> 函数，我们来看它的实现： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseInterpolation</span>(<span class="params">context, mode</span>) &#123; </span><br><span class="line">  <span class="comment">// 从配置中获取插值开始和结束分隔符，默认是 &#123;&#123; 和 &#125;&#125; </span></span><br><span class="line">  <span class="keyword">const</span> [open, close] = context.<span class="property">options</span>.<span class="property">delimiters</span> </span><br><span class="line">  <span class="keyword">const</span> closeIndex = context.<span class="property">source</span>.<span class="title function_">indexOf</span>(close, open.<span class="property">length</span>) </span><br><span class="line">  <span class="keyword">if</span> (closeIndex === -<span class="number">1</span>) &#123; </span><br><span class="line">    <span class="title function_">emitError</span>(context, <span class="number">25</span> <span class="comment">/* X_MISSING_INTERPOLATION_END */</span>) </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span> </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">const</span> start = <span class="title function_">getCursor</span>(context) </span><br><span class="line">  <span class="comment">// 代码前进到插值开始分隔符后 </span></span><br><span class="line">  <span class="title function_">advanceBy</span>(context, open.<span class="property">length</span>) </span><br><span class="line">  <span class="comment">// 内部插值开始位置 </span></span><br><span class="line">  <span class="keyword">const</span> innerStart = <span class="title function_">getCursor</span>(context) </span><br><span class="line">  <span class="comment">// 内部插值结束位置 </span></span><br><span class="line">  <span class="keyword">const</span> innerEnd = <span class="title function_">getCursor</span>(context) </span><br><span class="line">  <span class="comment">// 插值原始内容的长度 </span></span><br><span class="line">  <span class="keyword">const</span> rawContentLength = closeIndex - open.<span class="property">length</span> </span><br><span class="line">  <span class="comment">// 插值原始内容 </span></span><br><span class="line">  <span class="keyword">const</span> rawContent = context.<span class="property">source</span>.<span class="title function_">slice</span>(<span class="number">0</span>, rawContentLength) </span><br><span class="line">  <span class="comment">// 获取插值的内容，并前进代码到插值的内容后 </span></span><br><span class="line">  <span class="keyword">const</span> preTrimContent = <span class="title function_">parseTextData</span>(context, rawContentLength, mode) </span><br><span class="line">  <span class="keyword">const</span> content = preTrimContent.<span class="title function_">trim</span>() </span><br><span class="line">  <span class="comment">// 内容相对于插值开始分隔符的头偏移 </span></span><br><span class="line">  <span class="keyword">const</span> startOffset = preTrimContent.<span class="title function_">indexOf</span>(content) </span><br><span class="line">  <span class="keyword">if</span> (startOffset &gt; <span class="number">0</span>) &#123; </span><br><span class="line">    <span class="comment">// 更新内部插值开始位置 </span></span><br><span class="line">    <span class="title function_">advancePositionWithMutation</span>(innerStart, rawContent, startOffset) </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// 内容相对于插值结束分隔符的尾偏移 </span></span><br><span class="line">  <span class="keyword">const</span> endOffset = rawContentLength - (preTrimContent.<span class="property">length</span> - content.<span class="property">length</span> - startOffset) </span><br><span class="line">  <span class="comment">// 更新内部插值结束位置 </span></span><br><span class="line">  <span class="title function_">advancePositionWithMutation</span>(innerEnd, rawContent, endOffset); </span><br><span class="line">  <span class="comment">// 前进代码到插值结束分隔符后 </span></span><br><span class="line">  <span class="title function_">advanceBy</span>(context, close.<span class="property">length</span>) </span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    <span class="attr">type</span>: <span class="number">5</span> <span class="comment">/* INTERPOLATION */</span>, </span><br><span class="line">    <span class="attr">content</span>: &#123; </span><br><span class="line">      <span class="attr">type</span>: <span class="number">4</span> <span class="comment">/* SIMPLE_EXPRESSION */</span>, </span><br><span class="line">      <span class="attr">isStatic</span>: <span class="literal">false</span>, </span><br><span class="line">      <span class="attr">isConstant</span>: <span class="literal">false</span>, </span><br><span class="line">      content, </span><br><span class="line">      <span class="attr">loc</span>: <span class="title function_">getSelection</span>(context, innerStart, innerEnd) </span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">loc</span>: <span class="title function_">getSelection</span>(context, start) </span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>parseInterpolation 的实现也很简单，首先它会尝试找插值的结束分隔符，如果找不到则报错。</p>
<p>如果找到，先前进代码到插值开始分隔符后，然后通过 parseTextData 获取插值中间的内容并前进代码到插值内容后，除了普通字符串，parseTextData 内部会处理一些 HTML 实体符号比如 <code>&amp;nbsp</code> 。由于插值的内容可能是前后有空白字符的，所以最终返回的 content 需要执行一下 trim 函数。</p>
<p>为了准确地反馈插值内容的代码位置信息，我们使用了 innerStart 和 innerEnd 去记录插值内容（不包含空白字符）的代码开头和结束位置。</p>
<p>接着就是前进代码到插值结束分隔符后，表示插值部分代码处理完毕，可以继续解析后续代码了。</p>
<p>parseInterpolation 最终返回的值就是一个描述插值节点的对象，其中 type 表示它是一个插值节点，loc 表示插值的代码开头和结束的位置信息，而 content 又是一个描述表达式节点的对象，其中 type 表示它是一个表达式节点，loc 表示内容的代码开头和结束的位置信息，content 表示插值的内容。</p>
<ul>
<li>普通文本的解析</li>
</ul>
<p>接下来，我们来看普通文本的解析过程，它会解析模板中的普通文本，比如 <code>This is an app</code> ，即当前代码 s 既不是以 { { 插值分隔符开头的字符串，也不是以 &lt; 开头的字符串，则走到普通文本的解析处理逻辑，我们来看 parseText 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseText</span>(<span class="params">context, mode</span>) &#123; </span><br><span class="line">  <span class="comment">// 文本结束符 </span></span><br><span class="line">  <span class="keyword">const</span> endTokens = [<span class="string">&#x27;&lt;&#x27;</span>, context.<span class="property">options</span>.<span class="property">delimiters</span>[<span class="number">0</span>]] </span><br><span class="line">  <span class="keyword">if</span> (mode === <span class="number">3</span> <span class="comment">/* CDATA */</span>) &#123; </span><br><span class="line">    <span class="comment">// CDATA 标记 XML 中的纯文本 </span></span><br><span class="line">    endTokens.<span class="title function_">push</span>(<span class="string">&#x27;]]&gt;&#x27;</span>) </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">let</span> endIndex = context.<span class="property">source</span>.<span class="property">length</span> </span><br><span class="line">  <span class="comment">// 遍历文本结束符，匹配找到结束的位置 </span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; endTokens.<span class="property">length</span>; i++) &#123; </span><br><span class="line">    <span class="keyword">const</span> index = context.<span class="property">source</span>.<span class="title function_">indexOf</span>(endTokens[i], <span class="number">1</span>) </span><br><span class="line">    <span class="keyword">if</span> (index !== -<span class="number">1</span> &amp;&amp; endIndex &gt; index) &#123; </span><br><span class="line">      endIndex = index </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">const</span> start = <span class="title function_">getCursor</span>(context) </span><br><span class="line">  <span class="comment">// 获取文本的内容，并前进代码到文本的内容后 </span></span><br><span class="line">  <span class="keyword">const</span> content = <span class="title function_">parseTextData</span>(context, endIndex, mode) </span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    <span class="attr">type</span>: <span class="number">2</span> <span class="comment">/* TEXT */</span>, </span><br><span class="line">    content, </span><br><span class="line">    <span class="attr">loc</span>: <span class="title function_">getSelection</span>(context, start) </span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>同样，parseText 的实现很简单。对于一段文本来说，都是在遇到 &lt; 或者插值分隔符 { { 结束，所以会遍历这些结束符，匹配并找到文本结束的位置，然后执行 parseTextData 获取文本的内容，并前进代码到文本的内容后。</p>
<p>parseText 最终返回的值就是一个描述文本节点的对象，其中 type 表示它是一个文本节点，content 表示文本的内容，loc 表示文本的代码开头和结束的位置信息。</p>
<p>这部分内容比较多，所以本课时的内容就先到这。下节课中，我们接着分析元素节点，继续解析 template 生成 AST 的背后实现原理。</p>
<blockquote>
<p><strong>本节课的相关代码在源代码中的位置如下：</strong><br>packages&#x2F;compiler-core&#x2F;src&#x2F;compile.ts<br>packages&#x2F;compiler-core&#x2F;src&#x2F;parse.ts</p>
</blockquote>

        
            <div id="toc-article">
                
  <div class="widget-wrap" id="toc-wrap">
    <h3 class="widget-title"><i class="fa fa-toc"></i> 文章目录</h3>
    <div class="widget">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90-AST-%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91"><span class="toc-text">生成 AST 抽象语法树</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%A3%E6%9E%90%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-text">创建解析上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-text">解析子节点</span></a></li></ol></li></ol>
    </div>
  </div>


            </div>
        
        
          <blockquote id="copyright">
              <p>原文链接: <a href="https://xiaozhouguo.github.io/2022/08/02/vue3/ast-one/">https://xiaozhouguo.github.io/2022/08/02/vue3/ast-one/</a></p>
              <p>版权声明: 转载请注明出处.</p>
          </blockquote>
        
      
    </div>
    <footer class="article-footer">
      
        <div class="article-tag-wrap">
          

          
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AST/" rel="tag">AST</a></li></ul>

          
    <div class="social-share">
      <span>分享到:</span>
    </div>



        </div>
      
      
        
<nav id="article-nav">
  
    <a href="/2022/08/01/vue3/watcher-two/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">older</strong>
      <div class="article-nav-title">
        
          侦听器的实现原理和使用场景 - 下篇
        
      </div>
    </a>
  
  
    <a href="/2022/08/03/vue3/ast-transform-one/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">newer</strong>
      <div class="article-nav-title">
        
          AST 节点内部做了哪些转换？- 上篇
        
      </div>
    </a>
  
</nav>

      
      
        
  <div id="comments"></div>









      
    </footer>
  </div>
</article>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-posts"></i> 最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/31/vue3/ast-two/">构造AST的完整流程是怎样的？ -下篇</a>
          </li>
        
          <li>
            <a href="/2022/08/03/vue3/ast-transform-one/">AST 节点内部做了哪些转换？- 上篇</a>
          </li>
        
          <li>
            <a href="/2022/08/02/vue3/ast-one/">构造AST的完整流程是怎么样的？ - 上篇</a>
          </li>
        
          <li>
            <a href="/2022/08/01/vue3/watcher-two/">侦听器的实现原理和使用场景 - 下篇</a>
          </li>
        
          <li>
            <a href="/2022/08/01/vue3/reactive-inner-two/">响应式内部的实现原理是怎么样的？- 下篇</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> 标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AST/" style="font-size: 16.67px;">AST</a> <a href="/tags/Array/" style="font-size: 10px;">Array</a> <a href="/tags/DOM-diff/" style="font-size: 13.33px;">DOM-diff</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Promise/" style="font-size: 10px;">Promise</a> <a href="/tags/computed/" style="font-size: 10px;">computed</a> <a href="/tags/life-cycle/" style="font-size: 10px;">life-cycle</a> <a href="/tags/nextTick/" style="font-size: 10px;">nextTick</a> <a href="/tags/provide/" style="font-size: 10px;">provide</a> <a href="/tags/reactive/" style="font-size: 16.67px;">reactive</a> <a href="/tags/regular-expression/" style="font-size: 10px;">regular expression</a> <a href="/tags/setup/" style="font-size: 10px;">setup</a> <a href="/tags/type-challanges/" style="font-size: 10px;">type-challanges</a> <a href="/tags/watch/" style="font-size: 13.33px;">watch</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-classify"></i> 分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MarkDown/">MarkDown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue2/">Vue2</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue3/">Vue3</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E8%BF%9B%E9%98%B6/">前端基础进阶</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E7%AA%A5-javascript/">小窥 javascript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-archive"></i> 归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022年</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018年</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017年</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-tag"></i> 标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AST/" rel="tag">AST</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Array/" rel="tag">Array</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DOM-diff/" rel="tag">DOM-diff</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Promise/" rel="tag">Promise</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/computed/" rel="tag">computed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life-cycle/" rel="tag">life-cycle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextTick/" rel="tag">nextTick</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/provide/" rel="tag">provide</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/regular-expression/" rel="tag">regular expression</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/setup/" rel="tag">setup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/type-challanges/" rel="tag">type-challanges</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/watch/" rel="tag">watch</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title"><i class="fa fa-link"></i> 友情链接</h3>
    <div class="widget">
      <ul>
      
        <li>
          <a target="_blank" rel="noopener" href="http://weibo.com/u/5531933570">weibo</a>
        </li>
      
      </ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <a id="totop" href="#top"></a>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>
        <a href="/sitemap.xml">网站地图</a>
        <span> | </span><a href="/atom.xml">订阅本站</a>
        <span> | </span><a href="/about/">联系博主</a>
      </p>
      
        <p>
          <i class="fa fa-visitors"></i>
          <i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>
          ，
          <i class="fa fa-views"></i>
          <i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>
        </p>
      
      <p>
        <span>Copyright &copy; 2022 guoxiaozhou.</span>
        <span>Theme by <a href="https://github.com/chaooo/hexo-theme-BlueLake/" target="_blank">BlueLake.</a></span>
        <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo.</a></span>
      </p>
    </div>
  </div>
</footer>

    </div>
  </div>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/search.json.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






  
<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  
    
<script src="/localshare/js/social-share.js"></script>

    
<script src="/localshare/js/qrcode.js"></script>

  
  



  
    
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

    
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

    <script>
      var gitalk = new Gitalk({
        clientID: '73caaf19e0a3f8e71ddd',
        clientSecret: 'd4447cc0909c43121bd44ccae5073305021cd6be',
        repo: 'blog',
        owner: 'XIAOZHOUGUO',
        admin: ['XIAOZHOUGUO'],
        id: md5(window.location.pathname),
        distractionFreeMode: false,
        language: 'zh-CN',
        pagerDirection: 'last'
      });
      gitalk.render('comments');
    </script>
  

  

  

  

  

  

  

  
  





</body>
</html>